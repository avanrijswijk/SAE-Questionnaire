<?php

// Exemple de mise en fonctionnement de protocole CAS  (en php)
// (Adapter selon vos besoins)



// 1. On active le tampon de sortie (INDISPENSABLE pour éviter le bug de rechargement)
// Cela permet d'envoyer les headers de redirection même s'il y a des espaces avant
ob_start();

// 2. Gestion des erreurs (à désactiver en production, utile en dev)
ini_set('display_errors', 1);
error_reporting(E_ALL);

// 3. Démarrage de la session
if (session_status() === PHP_SESSION_NONE) {
    // Optimisation pour éviter les blocages de session
    ini_set('session.cookie_secure', 0); // Car on est en HTTP sur l'IP
    ini_set('session.cookie_httponly', 1);
    session_start();
}

// --- CONFIGURATION CAS ---
$cas_host = 'cas.unilim.fr';
$cas_port = 443;
$cas_context = '/cas';

// --- DÉTECTION AUTOMATIQUE DE L'URL DE RETOUR ---
// On construit l'URL de la page actuelle pour que le CAS nous renvoie ici
$protocol = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on') ? "https" : "http";
$current_url = $protocol . "://" . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];

// On nettoie l'URL : on enlève le paramètre ?ticket=... s'il existe déjà pour éviter les boucles
$service_url = preg_replace('/([?&])ticket=[^&]+(&|$)/', '$1', $current_url);
// Petit nettoyage si le regex laisse un '?' ou '&' traîner à la fin
$service_url = rtrim($service_url, '?&');


// --- LOGIQUE D'AUTHENTIFICATION ---

// CAS 1 : L'utilisateur est DÉJÀ connecté
if (isset($_SESSION['cas_user'])) {
    // On ne fait rien, on laisse le reste du site s'afficher
    // Vous pouvez récupérer l'utilisateur avec $_SESSION['cas_user']
} 
// CAS 2 : On revient du CAS avec un ticket à valider
elseif (isset($_GET['ticket'])) {
    $ticket = $_GET['ticket'];
    
    // URL de validation interne (coulisses)
    $validate_url = "https://$cas_host:$cas_port$cas_context/serviceValidate?service=" . urlencode($service_url) . "&ticket=" . $ticket;

    // Requête cURL silencieuse (Zéro dépendance)
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $validate_url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false); // Important pour la VM
    curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false);
    
    $response = curl_exec($ch);
    curl_close($ch);

    // Analyse de la réponse XML
    if (preg_match('/<cas:user>(.*?)<\/cas:user>/', $response, $match)) {
        // SUCCÈS !
        $_SESSION['cas_user'] = $match[1];
        
        // REDIRECTION IMMÉDIATE vers la page propre (sans le ?ticket=...)
        // C'est ça qui corrige votre bug de rechargement
        header("Location: $service_url");
        exit();
    } else {
        // Échec critique
        die("Erreur d'authentification CAS. Réponse : " . htmlspecialchars($response));
    }
} 
// CAS 3 : L'utilisateur n'est pas connecté -> On l'envoie au CAS
else {
    $login_url = "https://$cas_host:$cas_port$cas_context/login?service=" . urlencode($service_url);
    header("Location: $login_url");
    exit();
}

// Fin du fichier config.php
// Tout code qui inclut ce fichier sera protégé par le CAS
?>