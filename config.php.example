<?php

if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

// Désactiver l'autoloader dépréciée de phpCAS pour éviter les warnings
if (function_exists('spl_autoload_unregister')) {
    // Supprimer tous les autoloaders enregistrés par phpCAS avant l'include
    $autoloaders = spl_autoload_functions();
    if ($autoloaders) {
        foreach ($autoloaders as $autoloader) {
            spl_autoload_unregister($autoloader);
        }
    }
}

// Inclure phpCAS depuis les sources directement
require_once __DIR__ . '/vendor/apereo/phpcas/source/CAS.php';

// Réenregistrer les autoloaders si nécessaire
if (isset($autoloaders) && $autoloaders) {
    foreach ($autoloaders as $autoloader) {
        spl_autoload_register($autoloader);
    }
}

// Configuration du serveur CAS de l'Université de Limoges
$cas_host = 'cas.unilim.fr';
$cas_context = '/cas';
$cas_port = 443;

// URL de votre propre serveur (important pour le retour après connexion)
define('MY_APP_URL', 'https://164.81.120.74');

// Initialisation de phpCAS
phpCAS::client(CAS_VERSION_2_0, $cas_host, $cas_port, $cas_context, '');

// permet à votre PHP d'accepter la réponse du serveur CAS sans validation SSL
phpCAS::setNoCasServerValidation();

// Vérifier si l'utilisateur est authentifié sinon forecer l'authentification
if (phpCAS::isAuthenticated()) {
    $_SESSION['cas_user'] = phpCAS::getUser();
} else {
    phpCAS::forceAuthentication(); 
}

?>
